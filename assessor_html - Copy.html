<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Care Assessment Tracker Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>	
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f7fb;
            min-height: 100vh;
            color: #2c3e50;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;	
            padding: 20px;
            display: none; /* Hidden by default until login */
        }

        header {
            background: white;
            padding: 25px;
            margin-bottom: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        h1 {
            font-size: 32px;
            margin-bottom: 5px;
            color: #16a085;
        }

        .subtitle {
            font-size: 14px;
            color: #7f8c8d;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .tab {
            padding: 12px 20px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 500;
            border-radius: 8px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            color: #2c3e50;
        }

        .tab i {
            font-size: 16px;
        }

        .tab.active {
            background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 160, 133, 0.3);
        }

        .tab:hover:not(.active) {
            background: #d5dbdb;
            transform: translateY(-1px);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.4s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: transform 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        }

        .card h3 {
            font-size: 14px;
            color: #7f8c8d;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .card .number {
            font-size: 42px;
            font-weight: bold;
            color: #16a085;
        }

        .card.warning .number { color: #e67e22; }
        .card.danger .number { color: #e74c3c; }
        .card.success .number { color: #27ae60; }

        .form-section {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            margin-bottom: 20px;
        }

        .form-section h2 {
            font-size: 22px;
            margin-bottom: 20px;
            color: #16a085;
            border-bottom: 3px solid #16a085;
            padding-bottom: 10px;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #2c3e50;
            font-size: 14px;
        }

        input, select, textarea {
            padding: 12px;
            border: 2px solid #dfe6e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #16a085;
        }

        button {
            background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);
            color: white;
            padding: 12px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(22, 160, 133, 0.3);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 160, 133, 0.4);
        }

        .btn-secondary { background: #95a5a6; }
        .btn-secondary:hover { background: #7f8c8d; }

        .btn-success { background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        th {
            background: linear-gradient(135deg, #16a085 0%, #1abc9c 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            user-select: none;
        }

        th:hover {
            background: #148f77;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 13px;
        }

        tr:hover {
            background-color: #f8fcfc;
        }

        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
            text-transform: uppercase;
        }

        .status-completed { background-color: #d4edda; color: #155724; }
        .status-pending { background-color: #fff3cd; color: #856404; }
        .status-overdue { background-color: #f8d7da; color: #721c24; }
        .status-partial { background-color: #fff3cd; color: #856404; }

        .action-btn {
            padding: 8px 16px;
            font-size: 12px;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .filter-section {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .filter-group {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
        }

        .modal-content {
            background-color: white;
            margin: 3% auto;
            padding: 35px;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover { color: #000; }

        .import-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .import-card {
            border: 2px dashed #16a085;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            background: #f8fffd;
        }

        .import-card h4 {
            margin: 10px 0;
            color: #16a085;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        /* LOGIN MODAL STYLES */
        #loginModal {
            display: flex;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
            justify-content: center;
            align-items: center;
        }

        .login-box {
            background-color: white;
            padding: 40px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .login-title {
            text-align: center;
            color: #16a085;
            margin-bottom: 30px;
            font-size: 24px;
        }

        #loadingOverlay {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #16a085;
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
<button onclick="testSave()" style="position:fixed;top:10px;right:10px;zindex:9999;background:red;color:white;padding:10px;border:none;">TEST SAVE</button>
    </style>
</head>
<body>
    <div id="loadingOverlay"><div class="spinner"></div></div>

    <!-- Login Modal -->
    <div id="loginModal">
        <div class="login-box">
            <h2 class="login-title">Care Assessment Tracker</h2>
            <form id="loginForm">
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="loginUsername" required style="width: 100%;">
                </div>
                <div class="form-group" style="margin-top: 15px;">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required style="width: 100%;">
                </div>
                <div id="loginError" style="color: #e74c3c; margin-top: 10px; font-size: 14px; display: none;"></div>
                <button type="submit" style="width: 100%; margin-top: 20px;">Login</button>
            </form>
        </div>
    </div>

    <div class="container">
        <header>
            <h1>Care Assessment Tracker Pro</h1>
            <p class="subtitle">Smart tracking for ongoing care assessments</p>
            <div id="syncStatus" style="font-size:12px; color:#16a085; margin-top:8px;"></div>
        </header>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
            <button class="tab" onclick="showTab('add')"><i class="fas fa-user-plus"></i> Add User</button>
            <button class="tab" onclick="showTab('manage')"><i class="fas fa-users"></i> Manage Users</button>
            <button class="tab" onclick="showTab('assessments')"><i class="fas fa-clipboard-list"></i> All Assessments</button>
            <button class="tab" onclick="showTab('staff')"><i class="fas fa-user-md"></i> Staff</button>
            <button class="tab" onclick="showTab('import')"><i class="fas fa-file-import"></i> Import</button>
            <button class="tab" onclick="showTab('export')"><i class="fas fa-file-export"></i> Export</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="tab-content active">
            <div class="filter-section">
                <div class="filter-group">
                    <label>View:</label>
                    <select id="periodFilter" onchange="updateDashboard()">
                        <option value="7">This Week</option>
                        <option value="30" selected>This Month</option>
                        <option value="90">3 Months</option>
                    </select>
                    <label>Staff:</label>
                    <select id="staffFilter" onchange="updateDashboard()">
                        <option value="all">All Staff</option>
                    </select>
                </div>
            </div>

            <div class="dashboard">
                <div class="card warning"><h3>Due This Week</h3><div class="number" id="dueThisWeek">0</div></div>
                <div class="card warning"><h3>Due This Month</h3><div class="number" id="dueThisMonth">0</div></div>
                <div class="card danger"><h3>Overdue</h3><div class="number" id="overdueItems">0</div></div>
                <div class="card success"><h3>Completed</h3><div class="number" id="completedItems">0</div></div>
                <div class="card"><h3>Initial</h3><div class="number" id="initialCount">0</div></div>
                <div class="card"><h3>Reviews</h3><div class="number" id="reviewsCount">0</div></div>
                <div class="card"><h3>Reassessments</h3><div class="number" id="reassessmentsCount">0</div></div>
                <div class="card"><h3>Total Users</h3><div class="number" id="totalUsers">0</div></div>
            </div>

            <div class="form-section">
                <h2>Upcoming & Overdue</h2>
                <table id="upcomingTable">
                    <thead>
                        <tr>
                            <th>User</th><th>Type</th><th>Due</th><th>Days</th><th>Staff</th><th>Status</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Add User -->
        <div id="add" class="tab-content">
            <div class="form-section">
                <h2>Add New Service User</h2>
                <form id="serviceUserForm">
                    <div class="form-grid">
                        <div class="form-group"><label>Name *</label><input type="text" id="userName" required></div>
                        <div class="form-group"><label>Package Start *</label><input type="date" id="packageStartDate" required></div>
                        <div class="form-group"><label>Postcode *</label><input type="text" id="postcode" required></div>
                        <div class="form-group"><label>Medication *</label>
                            <select id="medicationStatus" required>
                                <option value="Prompt">Prompt</option>
                                <option value="Self-administer">Self-administer</option>
                                <option value="Administer">Administer</option>
                            </select>
                        </div>
                        <div class="form-group"><label>Staff *</label>
                            <select id="assignedStaff" required><option value="">Select...</option></select>
                        </div>
                    </div>
                    <button type="submit">Add User</button>
                </form>
            </div>
        </div>

        <!-- Manage Users -->
        <div id="manage" class="tab-content">
            <div class="form-section">
                <h2>All Service Users</h2>
                <input type="text" id="searchUsers" placeholder="Search..." style="width: 300px; margin-bottom: 15px;">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>Name</th><th>Postcode</th><th>Start</th><th>Med</th><th>Next Due</th><th>Staff</th><th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- All Assessments -->
        <div id="assessments" class="tab-content">
            <div class="form-section">
                <h2>All Assessments & Reviews</h2>
                <input type="text" id="searchAssessments" placeholder="Search service user..." style="width: 300px; margin-bottom: 15px;" oninput="loadAllAssessments()">
                <div class="filter-group" style="margin-bottom: 15px;">
                    <select id="typeFilter" onchange="loadAllAssessments()">
                        <option value="all">All Types</option>
                        <option value="Initial Assessment">Initial</option>
                        <option value="3 Month Review">3M</option>
                        <option value="6 Month Review">6M</option>
                        <option value="9 Month Review">9M</option>
                        <option value="12 Month Reassessment">12M</option>
                        <option value="Mid-Year Assessment">Mid-Year</option>
                    </select>
                    <select id="statusFilter" onchange="loadAllAssessments()">
                        <option value="all">All Status</option>
                        <option value="pending">Pending</option>
                        <option value="partial">Partial</option>
                        <option value="completed">Completed</option>
                        <option value="overdue">Overdue</option>
                    </select>
                    <select id="staffFilterAssessments" onchange="loadAllAssessments()">
                        <option value="all">All Staff</option>
                    </select>
                </div>
                <table id="allAssessmentsTable">
                    <thead>
                        <tr>
                            <th onclick="sortTable(0)">User</th>
                            <th onclick="sortTable(1)">Type</th>
                            <th onclick="sortTable(2)">Due</th>
                            <th>Assessment Contact Date</th>
                            <th>Assessment Date</th>
                            <th>Write-up Completion Date</th>
                            <th>Completed By</th>
                            <th>Days (POC to Assessment)</th>
                            <th>Days (Assessment to Write-up)</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- Staff -->
        <div id="staff" class="tab-content">
            <div class="form-section">
                <h2>Staff Management</h2>
                <div class="form-grid">
                    <div class="form-group"><label>New Staff</label><input type="text" id="newStaffName"></div>
                    <div class="form-group" style="align-items: end;"><button onclick="addStaff()">Add</button></div>
                </div>
            </div>
            <div class="form-section" id="staffList"></div>
        </div>

        <!-- Import -->
        <div id="import" class="tab-content">
            <div class="form-section">
                <h2>Import Data (Phased)</h2>
                <div class="alert alert-info">
                    Upload Excel files in phases. Each import updates matching records.
                </div>
                <div class="import-options">
                    <div class="import-card">
                        <h4>1. Service Users</h4>
                        <p>Name, Postcode, Med Status, Start Date</p>
                        <input type="file" id="importUsers" accept=".xlsx" style="display:none;">
                        <button onclick="document.getElementById('importUsers').click()">Choose File</button>
                    </div>
                    <div class="import-card">
                        <h4>2. Initial Assessment</h4>
                        <p>User + Assessment Date</p>
                        <input type="file" id="importInitial" accept=".xlsx" style="display:none;">
                        <button onclick="document.getElementById('importInitial').click()">Choose File</button>
                    </div>
                    <div class="import-card">
                        <h4>3. Reassessments</h4>
                        <p>User + Reassessment Date</p>
                        <input type="file" id="importReassess" accept=".xlsx" style="display:none;">
                        <button onclick="document.getElementById('importReassess').click()">Choose File</button>
                    </div>
                    <div class="import-card">
                        <h4>4. Reviews</h4>
                        <p>User + Review Dates</p>
                        <input type="file" id="importReviews" accept=".xlsx" style="display:none;">
                        <button onclick="document.getElementById('importReviews').click()">Choose File</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Export -->
        <div id="export" class="tab-content">
            <div class="form-section">
                <h2>Export Data</h2>
                <button onclick="exportExcel('all')" class="btn-success">Export All</button>
                <button onclick="exportExcel('users')" class="btn-success">Users Only</button>
                <button onclick="exportExcel('assessments')" class="btn-success">Assessments Only</button>
            </div>
        </div>

        <!-- Update Modal -->
        <div id="updateModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeModal()">×</span>
                <h2 id="modalTitle">Update Assessment</h2>
                <form id="updateForm">
                    <input type="hidden" id="updateId">
                    <div class="form-grid">
                        <div class="form-group"><label>Assessment Contact Date</label><input type="date" id="updateContactDate"></div>
                        <div class="form-group"><label>Assessment Date</label><input type="date" id="updateAssessmentDate"></div>
                        <div class="form-group"><label>Write-up Completion Date</label><input type="date" id="updateWriteupDate"></div>
                        <div class="form-group"><label>Completed By</label><select id="updateCompletedBy"></select></div>
                    </div>
                    <button type="submit" class="btn-success">Save</button>
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                </form>
            </div>
        </div>

        <!-- Mid-Year Assessment Modal -->
        <div id="midYearModal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeMidYearModal()">×</span>
                <h2 id="midYearModalTitle">Add Mid-Year Assessment</h2>
                <form id="midYearForm">
                    <input type="hidden" id="midYearUserId">
                    <div class="form-grid">
                        <div class="form-group">
                            <label>Assessment Contact Date</label>
                            <input type="date" id="midYearContactDate">
                        </div>
                        <div class="form-group">
                            <label>Assessment Date *</label>
                            <input type="date" id="midYearAssessmentDate" required>
                        </div>
                        <div class="form-group">
                            <label>Write-up Completion Date</label>
                            <input type="date" id="midYearWriteupDate">
                        </div>
                        <div class="form-group">
                            <label>Completed By *</label>
                            <select id="midYearCompletedBy" required></select>
                        </div>
                        <div class="form-group">
                            <label>Reason *</label>
                            <select id="midYearReason" required>
                                <option value="">Select reason...</option>
                                <option value="Hospital Discharge">Hospital Discharge</option>
                                <option value="Family Request">Family Request</option>
                                <option value="Social Worker">Social Worker</option>
                                <option value="Council">Council</option>
                                <option value="Brokerage Team">Brokerage Team</option>
                                <option value="Others">Others</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 15px;">
                        <label>Notes</label>
                        <textarea id="midYearNotes" rows="4" style="width: 100%;"></textarea>
                    </div>
                    <button type="submit" class="btn-success">Save Mid-Year Assessment</button>
                    <button type="button" class="btn-secondary" onclick="closeMidYearModal()">Cancel</button>
                </form>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script>
    // ==== CONFIG ====
    const SPREADSHEET_ID = '1gLkdYbgQzDtF7SOodWFARH8Sa0LtutQIRimfXu4WvcI';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzGM8ZdOcr5xE-E4nPi7b59gT6ep2MES-EKBpALn2HtgvMQ1mBUw_pGD1T-SH69hliw/exec';

    let users = [], assessments = [], staff = ['John Smith', 'Sarah Johnson'];
    let isOnline = false;
    let isAuthenticated = false;
    let currentUser = null;
    let syncPending = false;

    // Show/hide loading
    function showLoading() { document.getElementById('loadingOverlay').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loadingOverlay').style.display = 'none'; }

    // Load from localStorage
    function loadLocal() {
        const saved = localStorage.getItem('careTrackerData');
        if (saved) {
            const data = JSON.parse(saved);
            users = data.users || [];
            assessments = data.assessments || [];
            staff = data.staff || staff;
        }
    }

async function testSave() {
  console.log('TEST: Forcing save with sample data');
  const testUsers = [{id: Date.now(), name: 'Debug User', postcode: 'TEST1', packageStartDate: '2023-01-01', medicationStatus: 'Prompt', assignedStaff: 'John Smith'}];
  try {
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'save', users: testUsers, assessments: [], staff: [] })
    });
    console.log('TEST RESPONSE:', await res.json());
    alert('Check Google Sheet "Users" tab for "Debug User"!');
  } catch (e) {
    console.error('TEST ERROR:', e);
  }
}
// === SAVE LOCALLY ===
function saveLocal() {
    localStorage.setItem('users', JSON.stringify(users));
    localStorage.setItem('assessments', JSON.stringify(assessments));
    localStorage.setItem('staff', JSON.stringify(staff));
}

// === LOAD LOCALLY ===
function loadLocal() {
    users = JSON.parse(localStorage.getItem('users') || '[]');
    assessments = JSON.parse(localStorage.getItem('assessments') || '[]');
    staff = JSON.parse(localStorage.getItem('staff') || '[]');
}

// === SYNC TO GOOGLE SHEETS ===
async function syncWithCloud() {
    try {
        document.getElementById('syncStatus').textContent = 'Syncing...';

        const response = await fetch(SCRIPT_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                action: 'save',
                users,
                assessments,
                staff
            })
        });

        const result = await response.json();
        if (result.success) {
            document.getElementById('syncStatus').textContent = 'Synced ✅';
            isOnline = true;
        } else {
            document.getElementById('syncStatus').textContent = 'Sync failed ❌';
            isOnline = false;
        }
    } catch (e) {
        console.error('Sync error:', e);
        document.getElementById('syncStatus').textContent = 'Offline (saved locally)';
        isOnline = false;
    }
}

// === LOAD FROM GOOGLE SHEETS ===
async function loadFromCloud() {
    try {
        const res = await fetch(`${SCRIPT_URL}?action=load`);
        const data = await res.json();

        users = data.users || [];
        assessments = data.assessments || [];
        staff = data.staff || [];

        saveLocal();
        document.getElementById('syncStatus').textContent = 'Loaded from Cloud ✅';
        isOnline = true;
    } catch (e) {
        console.error('Load error:', e);
        document.getElementById('syncStatus').textContent = 'Offline (local data)';
        loadLocal();
        isOnline = false;
    }
}

// === SAVE DATA THEN SYNC ===
async function saveData() {
    saveLocal();
    setTimeout(syncWithCloud, 200);
}


    // Initialize app
    async function init() {
        showLoading();
        loadLocal();
        await loadFromCloud();
        initStaff();
        updateDashboard();
        hideLoading();
    }

    function showTab(id) {
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelector(`button[onclick="showTab('${id}')"]`).classList.add('active');
        if (id === 'dashboard') updateDashboard();
        if (id === 'manage') loadUsers();
        if (id === 'assessments') loadAllAssessments();
        if (id === 'staff') loadStaff();
    }

    function initStaff() {
        const selects = ['assignedStaff', 'staffFilter', 'updateCompletedBy', 'staffFilterAssessments', 'midYearCompletedBy'];
        selects.forEach(id => {
            const sel = document.getElementById(id);
            if (!sel) return;
            const val = sel.value;
            sel.innerHTML = id.includes('Filter') ? '<option value="all">All Staff</option>' : '<option value="">Select...</option>';
            staff.forEach(s => sel.add(new Option(s, s)));
            if (val) sel.value = val;
        });
    }

    // Add User
    document.getElementById('serviceUserForm').onsubmit = async e => {
        e.preventDefault();
        const user = {
            id: Date.now() + Math.random(),
            name: document.getElementById('userName').value.trim(),
            postcode: document.getElementById('postcode').value.trim().toUpperCase(),
            packageStartDate: document.getElementById('packageStartDate').value,
            medicationStatus: document.getElementById('medicationStatus').value,
            assignedStaff: document.getElementById('assignedStaff').value
        };
        users.push(user);
        scheduleAssessments(user);
        await saveData();
        alert('User added!');
        e.target.reset();
        showTab('manage');
    };

    function scheduleAssessments(user) {
        const start = new Date(user.packageStartDate);
        const types = [
            { type: 'Initial Assessment', months: 0 },
            { type: '3 Month Review', months: 3 },
            { type: '6 Month Review', months: 6 },
            { type: '9 Month Review', months: 9 },
            { type: '12 Month Reassessment', months: 12 }
        ];
        types.forEach(t => {
            const due = new Date(start);
            due.setMonth(due.getMonth() + t.months);
            assessments.push({
                id: Date.now() + Math.random(),
                userId: user.id,
                type: t.type,
                dueDate: due.toISOString().split('T')[0],
                assessmentContactDate: null,
                assessmentDate: null,
                writeupCompletionDate: null,
                completedBy: null,
                daysToComplete: null,
                daysToWriteup: null,
                status: 'pending'
            });
        });
    }

    function updateDashboard() {
        const period = parseInt(document.getElementById('periodFilter').value);
        const staffFilter = document.getElementById('staffFilter').value;
        const today = new Date(); today.setHours(0,0,0,0);
        const end = new Date(); end.setDate(end.getDate() + period);

        let filtered = assessments.filter(a => {
            const u = users.find(x => x.id === a.userId);
            return u && (staffFilter === 'all' || u.assignedStaff === staffFilter);
        });

        document.getElementById('dueThisWeek').textContent = filtered.filter(a => {
            const d = new Date(a.dueDate);
            return d >= today && d <= new Date(today.getTime() + 7*24*60*60*1000) && a.status !== 'completed';
        }).length;

        document.getElementById('dueThisMonth').textContent = filtered.filter(a => {
            const d = new Date(a.dueDate);
            return d >= today && d <= end && a.status !== 'completed';
        }).length;

        document.getElementById('overdueItems').textContent = filtered.filter(a => new Date(a.dueDate) < today && a.status !== 'completed').length;
        document.getElementById('completedItems').textContent = filtered.filter(a => a.status === 'completed').length;
        document.getElementById('initialCount').textContent = filtered.filter(a => a.type === 'Initial Assessment' && a.status !== 'completed').length;
        document.getElementById('reviewsCount').textContent = filtered.filter(a => a.type.includes('Review') && a.status !== 'completed').length;
        document.getElementById('reassessmentsCount').textContent = filtered.filter(a => a.type === '12 Month Reassessment' && a.status !== 'completed').length;
        document.getElementById('totalUsers').textContent = users.length;

        loadUpcoming(filtered);
    }

    function loadUpcoming(list) {
        const tbody = document.querySelector('#upcomingTable tbody');
        tbody.innerHTML = '';
        const today = new Date(); today.setHours(0,0,0,0);
        list.filter(a => a.status !== 'completed').sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate)).forEach(a => {
            const u = users.find(x => x.id === a.userId);
            const days = Math.ceil((new Date(a.dueDate) - today) / 86400000);
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><strong>${u.name}</strong></td><td>${a.type}</td><td>${new Date(a.dueDate).toLocaleDateString()}</td>
                <td style="color:${days<0?'#e74c3c':'#333'}">${days>=0?days+' days':Math.abs(days)+' overdue'}</td>
                <td>${u.assignedStaff}</td><td><span class="status-badge status-${a.status}">${a.status}</span></td>
                <td><button class="action-btn btn-success" onclick="openUpdate(${a.id})">Update</button></td>`;
            tbody.appendChild(tr);
        });
    }

    function deleteUser(userId) {
        if (confirm('Delete this service user and all their assessments? This cannot be undone.')) {
            users = users.filter(u => u.id !== userId);
            assessments = assessments.filter(a => a.userId !== userId);
            saveData().then(() => {
                loadUsers();
                updateDashboard();
                alert('User deleted.');
            });
        }
    }

    function openMidYearAssessment(userId) {
        const user = users.find(u => u.id === userId);
        if (!user) return;
        
        document.getElementById('midYearModalTitle').textContent = `Add Mid-Year Assessment - ${user.name}`;
        document.getElementById('midYearUserId').value = userId;
        
        const sel = document.getElementById('midYearCompletedBy');
        sel.innerHTML = '<option value="">Select staff...</option>';
        staff.forEach(s => sel.add(new Option(s, s)));
        
        document.getElementById('midYearForm').reset();
        document.getElementById('midYearUserId').value = userId;
        
        document.getElementById('midYearModal').style.display = 'block';
    }

    function closeMidYearModal() {
        document.getElementById('midYearModal').style.display = 'none';
    }

    document.getElementById('midYearForm').onsubmit = async e => {
        e.preventDefault();
        const userId = parseFloat(document.getElementById('midYearUserId').value);
        const user = users.find(u => u.id === userId);
        
        const contactDate = document.getElementById('midYearContactDate').value || null;
        const assessmentDate = document.getElementById('midYearAssessmentDate').value;
        const writeupDate = document.getElementById('midYearWriteupDate').value || null;
        const completedBy = document.getElementById('midYearCompletedBy').value;
        const reason = document.getElementById('midYearReason').value;
        const notes = document.getElementById('midYearNotes').value.trim();
        
        let status = 'pending';
        if (writeupDate && completedBy) status = 'completed';
        else if (assessmentDate && completedBy) status = 'partial';
        
        let daysToComplete = null;
        let daysToWriteup = null;
        
        if (assessmentDate) {
            daysToComplete = Math.ceil((new Date(assessmentDate) - new Date(user.packageStartDate)) / 86400000);
        }
        if (writeupDate && assessmentDate) {
            daysToWriteup = Math.ceil((new Date(writeupDate) - new Date(assessmentDate)) / 86400000);
        }
        
        const midYearAssessment = {
            id: Date.now() + Math.random(),
            userId: userId,
            type: 'Mid-Year Assessment',
            dueDate: assessmentDate,
            assessmentContactDate: contactDate,
            assessmentDate: assessmentDate,
            writeupCompletionDate: writeupDate,
            completedBy: completedBy,
            daysToComplete: daysToComplete,
            daysToWriteup: daysToWriteup,
            status: status,
            reason: reason,
            notes: notes
        };
        
        assessments.push(midYearAssessment);
        
        await saveData();
        closeMidYearModal();
        alert('Mid-Year Assessment added successfully!');
        loadAllAssessments();
        updateDashboard();
    };

    function loadUsers() {
        const tbody = document.querySelector('#usersTable tbody');
        tbody.innerHTML = '';
        const term = document.getElementById('searchUsers').value.toLowerCase();
        users.filter(u => u.name.toLowerCase().includes(term) || u.postcode.toLowerCase().includes(term)).forEach(u => {
            const next = assessments.filter(a => a.userId === u.id && a.status !== 'completed').sort((a,b) => new Date(a.dueDate) - new Date(b.dueDate))[0];
            const tr = document.createElement('tr');
            tr.innerHTML = `<td><strong>${u.name}</strong></td><td>${u.postcode}</td><td>${new Date(u.packageStartDate).toLocaleDateString()}</td>
                <td>${u.medicationStatus}</td><td>${next ? next.type + '<br><small>' + new Date(next.dueDate).toLocaleDateString() + '</small>' : 'None'}</td>
                <td>${u.assignedStaff}</td><td><button class="action-btn" style="background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);" onclick="openMidYearAssessment(${u.id})">Mid-Year</button><button class="action-btn btn-danger" onclick="deleteUser(${u.id})">Delete</button></td>`;
            tbody.appendChild(tr);
        });
    }

    function loadAllAssessments() {
        const tbody = document.querySelector('#allAssessmentsTable tbody');
        tbody.innerHTML = '';
        const type = document.getElementById('typeFilter').value;
        const status = document.getElementById('statusFilter').value;
        const staffF = document.getElementById('staffFilterAssessments').value;
        const today = new Date(); today.setHours(0,0,0,0);
        const searchTerm = document.getElementById('searchAssessments').value.toLowerCase();

        let list = assessments.filter(a => {
            const u = users.find(x => x.id === a.userId);
            const matchesSearch = !searchTerm || u?.name.toLowerCase().includes(searchTerm);
            return u && matchesSearch && (type === 'all' || a.type === type) && (staffF === 'all' || u.assignedStaff === staffF);
        });

        if (status !== 'all') {
            list = list.filter(a => {
                if (status === 'overdue') return new Date(a.dueDate) < today && a.status !== 'completed';
                return a.status === status;
            });
        }

        list.forEach(a => {
            const u = users.find(x => x.id === a.userId);
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${u.name}</td><td>${a.type}</td><td>${new Date(a.dueDate).toLocaleDateString()}</td>
                <td>${a.assessmentContactDate ? new Date(a.assessmentContactDate).toLocaleDateString() : '-'}</td>
                <td>${a.assessmentDate ? new Date(a.assessmentDate).toLocaleDateString() : '-'}</td>
                <td>${a.writeupCompletionDate ? new Date(a.writeupCompletionDate).toLocaleDateString() : '-'}</td>
                <td>${a.completedBy || '-'}</td>
                <td>${a.daysToComplete !== null ? a.daysToComplete + ' days' : '-'}</td>
                <td>${a.daysToWriteup !== null ? a.daysToWriteup + ' days' : '-'}</td>
                <td><span class="status-badge status-${a.status}">${a.status}</span></td>
                <td><button class="action-btn btn-success" onclick="openUpdate(${a.id})">Update</button>
                    <button class="action-btn btn-danger" onclick="deleteAssessment(${a.id})">Delete</button></td>`;
            tbody.appendChild(tr);
        });
    }

    function sortTable(col) {
        const table = document.getElementById('allAssessmentsTable');
        const rows = Array.from(table.querySelectorAll('tbody tr'));
        const isAsc = table.dataset.sortCol === col && table.dataset.sortDir === 'asc';
        table.dataset.sortCol = col;
        table.dataset.sortDir = isAsc ? 'desc' : 'asc';

        rows.sort((a, b) => {
            let A = a.cells[col].textContent.trim();
            let B = b.cells[col].textContent.trim();
            if (col >= 2 && col <= 6) {
                A = A === '-' ? '' : new Date(A);
                B = B === '-' ? '' : new Date(B);
            }
            const res = A > B ? 1 : A < B ? -1 : 0;
            return isAsc ? -res : res;
        });

        rows.forEach(r => table.querySelector('tbody').appendChild(r));
    }

    function openUpdate(id) {
        const a = assessments.find(x => x.id === id);
        const u = users.find(x => x.id === a.userId);
        document.getElementById('modalTitle').textContent = `${a.type} - ${u.name}`;
        document.getElementById('updateId').value = id;
        document.getElementById('updateContactDate').value = a.assessmentContactDate || '';
        document.getElementById('updateAssessmentDate').value = a.assessmentDate || '';
        document.getElementById('updateWriteupDate').value = a.writeupCompletionDate || '';
        document.getElementById('updateCompletedBy').value = a.completedBy || '';
        document.getElementById('updateModal').style.display = 'block';
    }

    document.getElementById('updateForm').onsubmit = async e => {
        e.preventDefault();
        const id = parseFloat(document.getElementById('updateId').value);
        const a = assessments.find(x => x.id === id);
        const u = users.find(x => x.id === a.userId);

        a.assessmentContactDate = document.getElementById('updateContactDate').value || null;
        a.assessmentDate = document.getElementById('updateAssessmentDate').value || null;
        a.writeupCompletionDate = document.getElementById('updateWriteupDate').value || null;
        a.completedBy = document.getElementById('updateCompletedBy').value || null;

        if (a.writeupCompletionDate && a.completedBy) a.status = 'completed';
        else if (a.assessmentDate && a.completedBy) a.status = 'partial';
        else a.status = 'pending';

        if (a.assessmentDate) {
            a.daysToComplete = Math.ceil((new Date(a.assessmentDate) - new Date(u.packageStartDate)) / 86400000);
        } else {
            a.daysToComplete = null;
        }
        
        if (a.writeupCompletionDate && a.assessmentDate) {
            a.daysToWriteup = Math.ceil((new Date(a.writeupCompletionDate) - new Date(a.assessmentDate)) / 86400000);
        } else {
            a.daysToWriteup = null;
        }

        if (a.type === '12 Month Reassessment' && a.status === 'completed' && a.writeupCompletionDate) {
            const base = new Date(a.assessmentDate);
            const next = [
                { type: '3 Month Review', m: 3 },
                { type: '6 Month Review', m: 6 },
                { type: '9 Month Review', m: 9 },
                { type: '12 Month Reassessment', m: 12 }
            ];
            next.forEach(n => {
                const due = new Date(base);
                due.setMonth(due.getMonth() + n.m);
                assessments.push({
                    id: Date.now() + Math.random(),
                    userId: u.id,
                    type: n.type,
                    dueDate: due.toISOString().split('T')[0],
                    assessmentContactDate: null, assessmentDate: null, writeupCompletionDate: null,
                    completedBy: null, daysToComplete: null, daysToWriteup: null,
                    status: 'pending'
                });
            });
        }

        await saveData();
        closeModal();
        loadAllAssessments();
        updateDashboard();
    };

    function closeModal() { document.getElementById('updateModal').style.display = 'none'; }

    function deleteAssessment(id) {
        if (confirm('Delete this assessment?')) {
            assessments = assessments.filter(a => a.id !== id);
            saveData().then(() => { loadAllAssessments(); updateDashboard(); });
        }
    }

    function addStaff() {
        const name = document.getElementById('newStaffName').value.trim();
        if (name && !staff.includes(name)) {
            staff.push(name);
            document.getElementById('newStaffName').value = '';
            saveData().then(() => {
                initStaff();
                loadStaff();
                alert('Staff added!');
            });
        } else if (!name) {
            alert('Enter a name');
        } else {
            alert('Staff already exists');
        }
    }

    function editStaff(index, oldName) {
        const newName = prompt('Edit staff name:', oldName);
        if (!newName || newName.trim() === '') {
            alert('Name cannot be empty');
            return;
        }
        
        const trimmedName = newName.trim();
        
        if (staff.some((s, i) => s === trimmedName && i !== index)) {
            alert('Staff name already exists');
            return;
        }
        
        const oldStaffName = staff[index];
        staff[index] = trimmedName;
        
        users.forEach(u => {
            if (u.assignedStaff === oldStaffName) {
                u.assignedStaff = trimmedName;
            }
        });
        
        assessments.forEach(a => {
            if (a.completedBy === oldStaffName) {
                a.completedBy = trimmedName;
            }
        });
        
        saveData().then(() => {
            initStaff();
            loadStaff();
            loadUsers();
            loadAllAssessments();
            updateDashboard();
            alert('Staff name updated!');
        });
    }

    function deleteStaff(index, staffName) {
        const assignedUsers = users.filter(u => u.assignedStaff === staffName);
        const completedAssessments = assessments.filter(a => a.completedBy === staffName);
        
        if (assignedUsers.length > 0) {
            alert(`Cannot delete ${staffName}. They are assigned to ${assignedUsers.length} user(s). Please reassign these users first.`);
            return;
        }
        
        if (completedAssessments.length > 0) {
            const confirmMsg = `${staffName} has completed ${completedAssessments.length} assessment(s). These will be marked as completed by "Former Staff Member". Continue?`;
            if (!confirm(confirmMsg)) return;
            
            assessments.forEach(a => {
                if (a.completedBy === staffName) {
                    a.completedBy = 'Former Staff Member';
                }
            });
        } else {
            if (!confirm(`Delete ${staffName}?`)) return;
        }
        
        staff.splice(index, 1);
        
        saveData().then(() => {
            initStaff();
            loadStaff();
            loadAllAssessments();
            alert('Staff deleted!');
        });
    }

    function loadStaff() {
        const container = document.getElementById('staffList');
        container.innerHTML = '<h2>Staff List</h2>';
        staff.forEach((s, index) => {
            const div = document.createElement('div');
            div.style = 'padding:10px; background:#f8fffd; margin:5px 0; border-left:4px solid #16a085; display: flex; justify-content: space-between; align-items: center;';
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = s;
            nameSpan.style.flex = '1';
            
            const btnContainer = document.createElement('div');
            btnContainer.style.display = 'flex';
            btnContainer.style.gap = '5px';
            
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Edit';
            editBtn.className = 'action-btn';
            editBtn.style.background = 'linear-gradient(135deg, #3498db 0%, #2980b9 100%)';
            editBtn.onclick = () => editStaff(index, s);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'action-btn btn-danger';
            deleteBtn.onclick = () => deleteStaff(index, s);
            
            btnContainer.appendChild(editBtn);
            btnContainer.appendChild(deleteBtn);
            div.appendChild(nameSpan);
            div.appendChild(btnContainer);
            container.appendChild(div);
        });
    }

    // IMPORTS
    document.getElementById('importUsers').onchange = e => importFile(e, 'users');
    document.getElementById('importInitial').onchange = e => importFile(e, 'initial');
    document.getElementById('importReassess').onchange = e => importFile(e, 'reassess');
    document.getElementById('importReviews').onchange = e => importFile(e, 'reviews');

    async function importFile(event, type) {
        const file = event.target.files[0];
        if (!file) return;
        showLoading();
        const reader = new FileReader();
        reader.onload = async e => {
            try {
                const data = new Uint8Array(e.target.result);
                const wb = XLSX.read(data, { type: 'array' });
                const ws = wb.Sheets[wb.SheetNames[0]];
                const rows = XLSX.utils.sheet_to_json(ws);

                if (type === 'users') {
                    rows.forEach(r => {
                        if (!r.Name || !r['Package Start Date']) return;
                        if (users.find(u => u.name === r.Name)) return;
                        const user = {
                            id: Date.now() + Math.random(),
                            name: r.Name,
                            postcode: (r.Postcode || '').toString().toUpperCase(),
                            packageStartDate: r['Package Start Date'],
                            medicationStatus: r['Medication Status'] || '',
                            assignedStaff: r['Assigned Staff'] || staff[0] || 'John Smith'
                        };
                        users.push(user);
                        scheduleAssessments(user);
                    });
                } else if (type === 'initial') {
                    rows.forEach(r => {
                        const u = users.find(x => x.name === r['Service User']);
                        const a = assessments.find(x => x.userId === u?.id && x.type === 'Initial Assessment');
                        if (a && r['Assessment Date']) {
                            a.assessmentDate = r['Assessment Date'];
                            a.completedBy = r['Completed By'] || null;
                            a.writeupCompletionDate = r['Write-up Completion Date'] || null;
                            updateStatusAndDays(a, u);
                        }
                    });
                } else if (type === 'reassess') {
                    rows.forEach(r => {
                        const u = users.find(x => x.name === r['Service User']);
                        const a = assessments.find(x => x.userId === u?.id && x.type === '12 Month Reassessment');
                        if (a && r['Assessment Date']) {
                            a.assessmentDate = r['Assessment Date'];
                            a.completedBy = r['Completed By'] || null;
                            a.writeupCompletionDate = r['Write-up Completion Date'] || null;
                            updateStatusAndDays(a, u);
                        }
                    });
                } else if (type === 'reviews') {
                    rows.forEach(r => {
                        const u = users.find(x => x.name === r['Service User']);
                        ['3 Month Review', '6 Month Review', '9 Month Review'].forEach(t => {
                            const a = assessments.find(x => x.userId === u?.id && x.type === t);
                            if (a && r[t]) {
                                a.assessmentDate = r[t];
                                a.completedBy = r['Completed By'] || null;
                                a.writeupCompletionDate = r['Write-up Completion Date'] || null;
                                updateStatusAndDays(a, u);
                            }
                        });
                    });
                }

                await saveData();
                hideLoading();
                alert('Import complete!');
                loadAllAssessments();
                updateDashboard();
            } catch (err) { hideLoading(); alert('Import error: ' + err.message); }
        };
        reader.readAsArrayBuffer(file);
        event.target.value = '';
    }

    function updateStatusAndDays(a, u) {
        if (a.writeupCompletionDate && a.completedBy) a.status = 'completed';
        else if (a.assessmentDate && a.completedBy) a.status = 'partial';
        else a.status = 'pending';

        if (a.assessmentDate && a.daysToComplete === null) {
            a.daysToComplete = Math.ceil((new Date(a.assessmentDate) - new Date(u.packageStartDate)) / 86400000);
        }
        if (a.writeupCompletionDate && a.assessmentDate && a.daysToWriteup === null) {
            a.daysToWriteup = Math.ceil((new Date(a.writeupCompletionDate) - new Date(a.assessmentDate)) / 86400000);
        }
    }

    function exportExcel(type) {
        const wb = XLSX.utils.book_new();
        if (type === 'all' || type === 'users') {
            const data = users.map(u => ({
                Name: u.name, Postcode: u.postcode, 'Package Start Date': u.packageStartDate,
                'Medication Status': u.medicationStatus, 'Assigned Staff': u.assignedStaff
            }));
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'Users');
        }
        if (type === 'all' || type === 'assessments') {
            const data = assessments.map(a => {
                const u = users.find(x => x.id === a.userId);
                return {
                    'Service User': u?.name, Type: a.type, 'Due Date': a.dueDate,
                    'Assessment Contact Date': a.assessmentContactDate || '',
                    'Assessment Date': a.assessmentDate || '',
                    'Write-up Completion Date': a.writeupCompletionDate || '',
                    'Completed By': a.completedBy || '',
                    'Days (POC to Assessment)': a.daysToComplete || '',
                    'Days (Assessment to Write-up)': a.daysToWriteup || ''
                };
            });
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), 'Assessments');
        }
        XLSX.writeFile(wb, `Care_Tracker_${new Date().toISOString().split('T')[0]}.xlsx`);
    }

    // ===== PAGE INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
        // Setup login form
        document.getElementById('loginForm').onsubmit = async function(e) {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const errorDiv = document.getElementById('loginError');
            
            showLoading();
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch(`${SCRIPT_URL}?action=authenticate&username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`);
                const result = await response.json();
                
                if (result.authenticated) {
    isAuthenticated = true;
    currentUser = username;

    const modal = document.getElementById('loginModal');
    const app = document.querySelector('.container');

    // Fade out login modal smoothly
    modal.style.transition = 'opacity 0.3s ease';
    modal.style.opacity = '0';

    // Hide it completely after fade
    setTimeout(() => {
        modal.style.display = 'none';
        app.style.display = 'block';
    }, 300);

    await init();
}
 else {
                    errorDiv.textContent = 'Invalid username or password';
                    errorDiv.style.display = 'block';
                    hideLoading();
                }
            } catch (error) {
                errorDiv.textContent = 'Authentication failed. Please check your connection.';
                errorDiv.style.display = 'block';
                hideLoading();
            }
        };
        
        // Setup search handler
        document.getElementById('searchUsers').oninput = loadUsers;
        
        // Setup modal close handler
        window.onclick = e => {
            if (e.target.className === 'modal' && e.target.id !== 'loginModal') {
                e.target.style.display = 'none';
            }
        };
    });
    </script>
</body>
</html>